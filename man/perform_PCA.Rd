% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/perform_PCA.R
\name{perform_PCA}
\alias{perform_PCA}
\title{Perform Principal Component Analysis (PCA)}
\usage{
perform_PCA(
  data,
  scorePC = list(c(1, 2), c(1, 3), c(2, 3)),
  includeQC = FALSE,
  arrangeLevels = NULL,
  scoresEllipse = TRUE,
  scoresColorVar = NULL,
  scoresTitle = NULL,
  scoresLegend = NULL,
  includeScree = TRUE,
  screeWhat = c("variance", "eigenvalue")[1],
  screeType = c("bar", "line", "both")[3],
  screeTitle = "Scree Plot",
  screeMaxPC = NULL,
  screeShowValues = TRUE,
  screeShowCumulative = FALSE,
  showOutliers = FALSE,
  outlierGroups = "all"
)
}
\arguments{
\item{data}{List. This list must be a result from the \code{perform_PreprocessingPeakData} function.
The function will automatically detect if replicates were merged during preprocessing
and use the appropriate data matrix.}

\item{scorePC}{List. A list of 2-element numeric vectors, where each vector specifies
the principal components to plot. For example: list(c(1,2), c(1,3), c(2,3))
will generate 3 plots: PC1 vs PC2, PC1 vs PC3, and PC2 vs PC3.}

\item{includeQC}{Boolean. If \code{TRUE}, includes QC (Quality Control) samples in the analysis and plots.
If \code{FALSE}, uses only biological samples (BS). Defaults to \code{FALSE}.}

\item{arrangeLevels}{Vector. Determines how the groups will be arranged.
The format could be "c('group1', 'group2', ...)". Defaults to \code{NULL} which
sorts the groups in alphabetical order.}

\item{scoresEllipse}{Boolean. If \code{TRUE} (default), adds an ellipse in the scores plot.}

\item{scoresColorVar}{String. Optional. Column name from metadata to use for
continuous gradient coloring in scores plots (e.g., "Time", "Concentration").
If \code{NULL} (default), uses discrete \code{Group} colors instead.}

\item{scoresTitle}{String or Vector. The scores plot title(s). Can be a single string
(applied to all plots) or a vector of strings (one for each plot). If \code{NULL},
defaults to "PCA Scores Plot (PC\{i\} vs PC\{j\})".}

\item{scoresLegend}{String. The title in the legend section of the scores plot.
Defaults to \code{NULL} which means no legend title.}

\item{includeScree}{Boolean. If \code{TRUE}, generates a scree plot in addition to scores plots.
Defaults to \code{TRUE}.}

\item{screeWhat}{Character. What to plot in the scree plot: "variance" or "eigenvalue".
Defaults to "variance".}

\item{screeType}{Character. Type of scree plot: "bar", "line", or "both".
Defaults to "both".}

\item{screeTitle}{Character. Title for the scree plot. Defaults to "Scree Plot".}

\item{screeMaxPC}{Integer. Maximum number of PCs to show in scree plot.
If NULL, shows all available PCs up to 20. Defaults to \code{NULL}.}

\item{screeShowValues}{Boolean. If \code{TRUE}, shows variance/eigenvalue values on top of bars
and removes y-axis labels. Defaults to \code{TRUE}.}

\item{screeShowCumulative}{Boolean. If \code{TRUE}, shows cumulative variance explained
on top of the scree plot. Only works when screeWhat="variance". Defaults to \code{FALSE}.}

\item{showOutliers}{Boolean. If \code{TRUE}, labels samples that fall outside the 95\\%
confidence ellipse of their respective group directly on the scores plot(s).
Outlier detection exactly mirrors \code{ggplot2::stat_ellipse}: the ellipse is
computed from the group covariance matrix scaled by a t-distribution multiplier
(\code{qt(0.975, df = n - 1)^2}), and a point is flagged as an outlier when its
Mahalanobis distance (scaled by the same factor) exceeds 1. Requires at least
3 samples per group (the same minimum needed to draw an ellipse). Defaults to
\code{FALSE}. Note: has no effect when \code{scoresColorVar} is supplied, because
ellipses are not drawn in gradient-color mode.
Labels are rendered with \pkg{ggrepel} to prevent overlap; connecting segments
are drawn from each label to its corresponding point.}

\item{outlierGroups}{Character vector controlling which groups are checked for
outliers and labelled on the plot. Accepted values are:
\itemize{
\item \code{"all"} — every group present in the data (default).
\item Any group name(s) found in \code{Metadata$Group} (or
\code{Metadata_merged$Group} when replicates were merged), e.g.
\code{c("GroupA", "GroupB")}.
\item \code{"QC"} — a convenience alias that selects all QC-type groups
(\code{"SQC"}, \code{"EQC"}, \code{"QC"}) that are present in the data.
Note that QC samples must also be included via \code{includeQC = TRUE}
for this to have any effect.
}
Multiple values can be combined, e.g. \code{c("GroupA", "QC")}. Any value not
recognised as a group name present in the data will trigger a warning.
Defaults to \code{"all"}.}
}
\value{
Returns a list containing:
\itemize{
\item \code{plots}: A list of ggplot objects, one for each PC combination.
\item \code{scree_plot}: A ggplot object for the scree plot (if \code{includeScree}
is \code{TRUE}).
\item \code{plot_info}: A data frame with information about each plot (PC
combinations, variance explained).
\item \code{pca_results}: The PCA results object from \code{stats::prcomp}.
\item \code{data_used}: The data matrix used for PCA.
\item \code{variance_explained}: Data frame of variance explained (\\%) per PC.
\item \code{eigenvalues}: Data frame of eigenvalues per PC.
\item \code{scores_data}: A list of data frames, one per PC combination (named
identically to \code{plots}). Each data frame contains:
\itemize{
\item \code{Label} — sample name / row name.
\item \code{Group} — group assignment.
\item \code{Batch} — batch assignment.
\item \code{SampleType} — \code{"QC"} or \code{"Biological"}.
\item \code{PC<i>}, \code{PC<j>} — scores on the two plotted PCs.
\item \code{mahal_dist} — Mahalanobis distance from the group centroid
in the 2-D PC space (groups with < 3 samples receive \code{NA}).
\item \code{ellipse_threshold} — the t-based scaling factor used as the
95\\% CI boundary, matching \code{ggplot2::stat_ellipse} exactly
(\code{NA} for groups with < 3 samples).
\item \code{is_outlier} — logical; \code{TRUE} when the point lies
outside the 95\\% ellipse as drawn by \code{stat_ellipse}.
}
}
}
\description{
This function performs PCA and generates multiple scores plots at once based on a list of
principal component combinations, plus an optional scree plot. Each combination in the list
will produce a separate scores plot.
}
\examples{
\dontrun{
# Standard PCA with discrete groups
multi_plots <- perform_PCA(
  data = data_from_perform_PreprocessingPeakData_function,
  scorePC = list(c(1,2), c(1,3)),
  includeQC = FALSE
)

# PCA with outlier labeling for all groups
multi_plots_outliers <- perform_PCA(
  data = data_from_perform_PreprocessingPeakData_function,
  scorePC = list(c(1,2)),
  showOutliers = TRUE,
  outlierGroups = "all"
)

# Label outliers only in specific groups
multi_plots_sel <- perform_PCA(
  data = data_from_perform_PreprocessingPeakData_function,
  scorePC = list(c(1,2)),
  showOutliers = TRUE,
  outlierGroups = c("GroupA", "GroupB")
)

# PCA with gradient coloring by a continuous variable (e.g., "Time")
multi_plots_time <- perform_PCA(
  data = data_from_perform_PreprocessingPeakData_function,
  scorePC = list(c(1,2)),
  includeQC = TRUE,
  scoresColorVar = "Time",
  scoresLegend = "Collection Time"
)

plot_PCAScreeScores(multi_plots_time)

# Inspect per-sample scores and outlier flags
head(multi_plots_outliers$scores_data[["PC1_vs_PC2"]])
}
}
\references{
Becker, R. A., Chambers, J. M. and Wilks, A. R. (1988) The New S Language. Wadsworth & Brooks/Cole. (for prcomp)

Mardia, K. V., J. T. Kent, and J. M. Bibby (1979) Multivariate Analysis, London: Academic Press. (for prcomp)

Venables, W. N. and B. D. Ripley (2002) Modern Applied Statistics with S, Springer-Verlag. (for prcomp)
}
\author{
John Lennon L. Calorio
}
